"use strict";var PLAY="play",PAUSE="pause",SYNC="sync",SYNC_FROM="sync_from",COUNT="count",PING="ping",PONG="pong",app2=new Vue({el:"#container",data:{pageState:"login",ws:null,dp:null,syncState:!1,waitingPlay:!0,videoId:null,roomId:null,clientId:(new Date).getTime()+Math.floor(986885*Math.random()),vURL:null,sURL:null,connectState:"连接已断开",clientCount:0,messages:[]},methods:{createPlayer:function(e){var t=this,n=10,n=1e3<document.body.clientWidth?50:29;this.dp=new DPlayer({container:document.getElementById("dplayer"),video:{url:this.vURL},volume:.5,subtitle:{url:this.sURL,type:"webvtt",fontSize:n+"px",bottom:"5%",color:"#fff"}});n=this.dp;n.on("pause",function(){t.syncState?t.syncState=!1:(t.addMessage("您点击了暂停按钮！"),t.send({event:PAUSE}))}),n.on("play",function(){t.waitingPlay=!1,t.syncState?t.syncState=!1:(t.addMessage("您点击了播放按钮！"),t.send({event:PLAY}))}),n.on("seeking",function(){t.syncState?t.syncState=!1:t.sync()})},initConnection:function(){var s=this,e="wss://api.xuewen.ink/sync-play/ws/".concat(this.roomId,"/").concat(this.clientId);this.ws=new WebSocket(e);var e=this.ws,a=this.dp;e.onopen=function(e){console.log("Connection open."),s.addMessage("您已连接至同步服务器！"),s.checkConnection()},e.onclose=function(e){console.log("Connection closed.",e),s.addMessage("您已和同步服务器断开连接！"),s.checkConnection()},e.onmessage=function(e){console.log("Received Message: "+e.data);var t=JSON.parse(e.data),n=t.event;n===PLAY?s.waitingPlay?s.addMessage("请先点击播放按钮！"):(s.addMessage("您的好友点击了播放按钮！"),a.video.paused&&(s.syncState=!0,a.play())):n===PAUSE?s.waitingPlay?s.addMessage("请先点击播放按钮！"):(s.addMessage("您的好友点击了暂停按钮！"),a.video.paused||(s.syncState=!0,a.pause())):n===SYNC?(s.addMessage("好友已将进度同步到您的设备上！"),s.syncState=!0,e=t.data.time,a.seek(e)):n===SYNC_FROM?(s.addMessage("您的好友要求同步您的进度！"),s.sync()):n===COUNT?s.clientCount=t.data.count:n===PONG||console.log("unkonwn event")}},play:function(){this.dp.play()},pause:function(){this.dp.pause()},sync:function(){this.addMessage("已将您的进度同步至好友！"),this.send({event:SYNC,data:{time:this.dp.video.currentTime}})},syncFrom:function(){this.addMessage("您要求同步到好友的进度！"),this.send({event:SYNC_FROM})},send:function(e){this.ws.send(JSON.stringify(e))},addMessage:function(e){var t=new Date,n=t.getHours(),s=t.getMinutes(),t=t.getSeconds();e="[".concat(this.messages.length+1,"]: ").concat(n,"点").concat(s,"分").concat(t,"秒：")+e,this.messages.push(e)},checkConnection:function(){var e=this.ws;if(e){e=e.readyState;if(e===WebSocket.OPEN)return this.connectState="连接可用",!0;if(e===WebSocket.CONNECTING)return this.connectState="正在连接",!0}return this.connectState="连接已断开",this.addMessage("当前连接不可用！"),!1},checkAvailable:function(){var e=this.ws;if(e&&e.readyState===WebSocket.OPEN)return!0;return!1},enterRoom:function(){var n=this,e=this.videoId;axios.get("https://api.xuewen.ink/sync-play/video/"+e).then(function(e){var t,e=e.data;2e3===e.code&&(t=e.data)?n.initRoom(t):alert("视频编号不存在！")}).catch(function(e){console.log(e),alert("视频编号不存在！")})},initRoom:function(e){var t=this;this.vURL=e.videoUrl,this.sURL=e.subtitleUrl,this.roomId||(this.roomId=(new Date).getTime()+Math.floor(986885*Math.random())),this.pageState="player",this.createPlayer(),this.initConnection(),setInterval(function(){t.checkConnection()?t.send({event:PING,data:{time:t.dp.video.currentTime}}):t.initConnection()},6e3)}}});